<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统 I/O 监控仪表盘</title>
    <style>
        :root {
            /* 配色方案：暗色系 */
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent-read: #06b6d4; /* 青色 - 读 */
            --accent-write: #f97316; /* 橙色 - 写 */
            --border-color: #334155;
            --success: #10b981;
            --error: #ef4444;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.5;
            padding: 20px;
        }

        /* 顶部导航与状态 */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-badge {
            font-size: 0.85rem;
            padding: 6px 12px;
            border-radius: 4px;
            background-color: var(--card-bg);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid var(--border-color);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--text-secondary);
            flex-shrink: 0;
        }

        .status-dot.active {
            background-color: var(--success);
            box-shadow: 0 0 8px var(--success);
        }

        .status-dot.error {
            background-color: var(--error);
        }

        /* 刷新间隔下拉框样式 */
        .refresh-select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.85rem;
            cursor: pointer;
            outline: none;
            font-family: monospace;
            text-align: center;
            transition: background 0.2s, border-color 0.2s;
        }

        .refresh-select:hover {
            background-color: rgba(255, 255, 255, 0.15);
            border-color: var(--text-secondary);
        }

        .refresh-select:focus {
            border-color: var(--accent-read);
        }
        
        /* 下拉箭头自定义 (可选，这里简化处理，使用默认箭头但改色需特定浏览器支持，保持简洁) */
        .refresh-select option {
            background-color: var(--card-bg);
            color: var(--text-primary);
        }

        /* 状态时间样式 */
        #status-time {
            font-family: monospace;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .loading-spinner {
            border: 2px solid rgba(255,255,255,0.1);
            border-left-color: var(--text-primary);
            border-radius: 50%;
            width: 14px;
            height: 14px;
            animation: spin 1s linear infinite;
            display: none;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Total 区域：大卡片展示 */
        .total-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 40px;
        }

        @media (max-width: 768px) {
            .total-section {
                grid-template-columns: 1fr;
            }
        }

        .total-card {
            background: linear-gradient(145deg, #1e293b, #263346);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s;
        }

        .total-card:hover {
            transform: translateY(-2px);
            border-color: var(--text-secondary);
        }

        .total-label {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }

        .total-value {
            font-size: 3rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }

        .total-unit {
            font-size: 1rem;
            color: var(--text-secondary);
            font-weight: 400;
            margin-left: 5px;
        }

        .text-read { color: var(--accent-read); }
        .text-write { color: var(--accent-write); }

        .bar-bg {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 4px;
            width: 100%;
            background: rgba(255,255,255,0.1);
        }
        .bar-fill {
            height: 100%;
            width: 0%;
            transition: width 0.5s ease-out;
        }

        /* 磁盘列表区域 */
        .disks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .disk-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            transition: all 0.2s;
        }

        .disk-card:hover {
            border-color: var(--text-secondary);
            background-color: #253045;
        }

        .disk-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            padding-bottom: 8px;
        }

        .disk-name {
            font-family: monospace;
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .disk-io-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .io-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            width: 40px;
        }

        .io-val {
            font-family: monospace;
            font-weight: 600;
        }

        /* 提示信息 */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        .toast {
            background-color: var(--card-bg);
            border-left: 4px solid var(--error);
            color: var(--text-primary);
            padding: 12px 20px;
            border-radius: 4px;
            margin-top: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: none;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

    </style>
</head>
<body>

    <header>
        <h1>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
            </svg>
            I/O Monitor
        </h1>
        <!-- 状态栏 -->
        <div class="status-badge">
            <!-- 刷新间隔选择框 -->
            <select id="refresh-select" class="refresh-select" title="选择刷新间隔">
                <option value="1000">1s</option>
                <option value="2000" selected>2s</option>
                <option value="3000">3s</option>
                <option value="5000">5s</option>
                <option value="10000">10s</option>
            </select>

            <!-- 状态时间 -->
            <span id="status-time">--</span>
            
            <div id="status-dot" class="status-dot"></div>
            <span id="status-text">等待数据...</span>
            <div id="loading-spinner" class="loading-spinner"></div>
        </div>
    </header>

    <main>
        <!-- Total 核心展示区 -->
        <section class="total-section">
            <!-- 读 Total -->
            <div class="total-card">
                <div class="total-label">
                    <span>Total Read</span>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent-read)" stroke-width="2">
                        <path d="M12 5v14M5 12l7 7 7-7"/>
                    </svg>
                </div>
                <div>
                    <span id="total-read-val" class="total-value text-read">0.0</span>
                    <span class="total-unit">KB/s</span>
                </div>
                <div class="bar-bg">
                    <div id="total-read-bar" class="bar-fill" style="background-color: var(--accent-read);"></div>
                </div>
            </div>

            <!-- 写 Total -->
            <div class="total-card">
                <div class="total-label">
                    <span>Total Write</span>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent-write)" stroke-width="2">
                        <path d="M12 19V5M5 12l7-7 7 7"/>
                    </svg>
                </div>
                <div>
                    <span id="total-write-val" class="total-value text-write">0.0</span>
                    <span class="total-unit">KB/s</span>
                </div>
                <div class="bar-bg">
                    <div id="total-write-bar" class="bar-fill" style="background-color: var(--accent-write);"></div>
                </div>
            </div>
        </section>

        <!-- 磁盘详情列表 (按倒序排列) -->
        <section>
            <h2 style="margin-bottom: 20px; font-size: 1.2rem; color: var(--text-secondary);">磁盘详情</h2>
            <div id="disks-grid" class="disks-grid">
                <!-- Javascript 将在这里生成卡片 -->
                <div class="disk-card" style="display:flex; justify-content:center; align-items:center; min-height:100px; color: var(--text-secondary);">
                    暂无数据
                </div>
            </div>
        </section>
    </main>

    <div id="toast-container"></div>

    <script>
        // 配置
        const API_URL = '/io';
        
        // DOM 元素引用
        const els = {
            totalReadVal: document.getElementById('total-read-val'),
            totalWriteVal: document.getElementById('total-write-val'),
            totalReadBar: document.getElementById('total-read-bar'),
            totalWriteBar: document.getElementById('total-write-bar'),
            disksGrid: document.getElementById('disks-grid'),
            statusDot: document.getElementById('status-dot'),
            statusText: document.getElementById('status-text'),
            statusTime: document.getElementById('status-time'),
            refreshSelect: document.getElementById('refresh-select'), // 新增下拉框引用
            spinner: document.getElementById('loading-spinner'),
            toastContainer: document.getElementById('toast-container')
        };

        // 定时器 ID，用于清除旧的定时器
        let timerId = null;

        // 获取当前格式化时间函数 
        function getFormattedTime(){
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        // 辅助函数：显示 Toast 提示
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            els.toastContainer.appendChild(toast);
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // 核心逻辑：获取并渲染数据
        async function fetchData() {
            // 更新状态为加载中
            els.spinner.style.display = 'block';
            
            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status}`);
                }
                const data = await response.json();
                
                renderDashboard(data);
                
                // 更新状态为正常
                els.statusDot.className = 'status-dot active';
                els.statusText.textContent = '运行中';
                
            } catch (error) {
                console.error("Fetch error:", error);
                els.statusDot.className = 'status-dot error';
                els.statusText.textContent = '连接错误';
                showToast(`无法获取数据: ${error.message}`);
            } finally {
                // 无论成功失败，停止加载动画
                els.spinner.style.display = 'none';
                
                // 每次请求结束后刷新时间
                els.statusTime.textContent = getFormattedTime();
            }
        }

        // 启动/重启定时器
        function startPolling(intervalMs) {
            // 如果之前有定时器，先清除
            if (timerId) {
                clearInterval(timerId);
            }
            // 设置新的定时器
            timerId = setInterval(fetchData, intervalMs);
            console.log(`刷新间隔已更新为: ${intervalMs}ms`);
        }

        // 渲染仪表盘
        function renderDashboard(data) {
            // 1. 处理 Total 数据
            const total = data['total'] || { read: "0.0", write: "0.0", unit: "KB/s" };
            const readVal = parseFloat(total.read);
            const writeVal = parseFloat(total.write);

            // 更新文本
            els.totalReadVal.textContent = readVal.toFixed(1);
            els.totalWriteVal.textContent = writeVal.toFixed(1);

            // 更新 Total 进度条 (简单的视觉比例，假设满量程为 100MB/s = 100000 KB/s)
            const maxScale = 100000; 
            els.totalReadBar.style.width = Math.min((readVal / maxScale) * 100, 100) + '%';
            els.totalWriteBar.style.width = Math.min((writeVal / maxScale) * 100, 100) + '%';

            // 2. 处理各个磁盘数据
            // 过滤掉 'total'，获取其他磁盘名
            let diskNames = Object.keys(data).filter(key => key !== 'total');
            
            // 按字母顺序排序 (A -> Z)
            diskNames.sort((a, b) => a.localeCompare(b));

            // 清空旧内容
            els.disksGrid.innerHTML = '';

            diskNames.forEach(name => {
                const disk = data[name];
                const r = parseFloat(disk.read).toFixed(1);
                const w = parseFloat(disk.write).toFixed(1);
                
                // 创建卡片 DOM
                const card = document.createElement('div');
                card.className = 'disk-card';
                card.innerHTML = `
                    <div class="disk-header">
                        <span class="disk-name">${name}</span>
                        <span style="font-size:0.8rem; color:#64748b">${disk.unit}</span>
                    </div>
                    <div class="disk-io-row">
                        <span class="io-label">Read</span>
                        <span class="io-val text-read">${r}</span>
                    </div>
                    <div class="disk-io-row">
                        <span class="io-label">Write</span>
                        <span class="io-val text-write">${w}</span>
                    </div>
                `;
                els.disksGrid.appendChild(card);
            });
        }

        // 初始化
        function init() {
            // 初始先运行一次时间更新
            els.statusTime.textContent = getFormattedTime();

            // 监听下拉框变化事件
            els.refreshSelect.addEventListener('change', (e) => {
                const newInterval = parseInt(e.target.value);
                // 立即重新开始轮询
                startPolling(newInterval);
                // 为了更好的体验，改变间隔时立即请求一次数据
                fetchData();
            });

            // 立即执行一次请求
            fetchData();
            
            // 开启默认定时器 (2s)
            startPolling(2000);
        }

        // 启动
        init();

    </script>
</body>
</html>